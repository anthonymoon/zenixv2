#!/usr/bin/env bash
set -euo pipefail

# NixOS Templates Installation Script
# Unified installation system for all NixOS template configurations

# Colors and formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATES_DIR="$SCRIPT_DIR/templates"

# Default values
TEMPLATE=""
HOSTNAME=""
PROFILES=()
DISK="/dev/sda"
USERNAME="user"
TIMEZONE="UTC"
DRY_RUN=false
INTERACTIVE=false
PARAMS=()

# Help function
show_help() {
    cat << EOF
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    NixOS Template Installer                   ‚ïë
‚ïë                  Unified Multi-Repository System             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Usage: $0 [OPTIONS] <template> <hostname> [profiles...]

üìã Available Templates (AMD Workstation Optimized):
  modern           üöÄ Modern dynamic system with auto-detection
  ephemeral-zfs    üíæ ZFS ephemeral root system
  minimal-zfs      üîß Minimal ZFS system  
  deployment       üåê Deployment-focused system
  personal         üë§ Personal dotfiles configuration
  unified          üèóÔ∏è Unified disko-based system
  installer        üíø ZFS installer system
  legacy           üß™ Legacy/testing configurations

üí° Workstation Profile Examples:
  Desktop Environments: kde (Plasma6), gnome, hyprland
  Display Managers: tui-greet, gdm  
  System Versions: stable, unstable, hardened
  Usage Types: gaming, development, workstation

üñ•Ô∏è AMD Workstation Standards:
  ‚Ä¢ ZFS root filesystem with systemd-boot
  ‚Ä¢ AMDGPU driver support only
  ‚Ä¢ Always DHCP networking
  ‚Ä¢ PipeWire audio system
  ‚Ä¢ Wayland-first desktop environments

üéØ Quick Examples:
  $0 modern workstation desktop kde stable
  $0 ephemeral-zfs server headless stable  
  $0 personal laptop desktop hyprland unstable
  $0 --interactive  # Guided setup

‚öôÔ∏è Options:
  --disk DEVICE      Target disk (default: /dev/sda)
  --user USERNAME    Primary username (default: user)  
  --timezone TZ      System timezone (default: UTC)
  --param key=value  Set template parameter
  --dry-run          Show what would be done
  --list-profiles T  List available profiles for template T
  --interactive      Interactive guided setup
  --help             Show this help

üîß Parameters (via --param key=value):
  hostname          System hostname
  username          Primary user
  disk             Target disk device
  timezone         System timezone
  hostId           ZFS host ID (for ZFS templates)
  poolName         ZFS pool name (for ZFS templates)
  email            Email address (for personal template)

üìö Examples with Parameters:
  $0 --param hostId=abcd1234 ephemeral-zfs myserver headless
  $0 --disk /dev/nvme0n1 --user alice modern desktop kde
  $0 --param email=user@domain.com personal laptop hyprland

üåê Remote Installation:
  curl -sSL https://github.com/user/nixos-templates/raw/main/install.sh | bash -s -- modern workstation kde
EOF
}

# List available profiles for a template
list_profiles() {
    local template="$1"
    echo -e "${BLUE}Available profiles for template: ${template}${NC}"
    
    if [[ ! -f "$TEMPLATES_DIR/$template/template.nix" ]]; then
        echo -e "${RED}Template '$template' not found${NC}"
        return 1
    fi
    
    case "$template" in
        modern)
            echo "üñ•Ô∏è  Desktop: kde (Plasma6), gnome, hyprland"
            echo "üì∫ Display Manager: tui-greet, gdm"
            echo "‚öôÔ∏è  System: stable, unstable, hardened"
            echo "üéÆ Usage: gaming, development"
            ;;
        ephemeral-zfs|minimal-zfs)
            echo "‚öôÔ∏è  System: stable"
            echo "üíª Usage: headless, desktop"
            echo "üñ•Ô∏è  Desktop: kde, gnome, hyprland"
            ;;
        deployment)
            echo "üéØ Target: remote, local, vm"
            echo "‚öôÔ∏è  System: stable"
            ;;
        personal)
            echo "üñ•Ô∏è  Desktop: kde (Plasma6), hyprland"
            echo "‚öôÔ∏è  System: stable, unstable"
            ;;
        unified|installer|legacy)
            echo "‚öôÔ∏è  System: stable"
            echo "üíª Usage: desktop, workstation"
            echo "üñ•Ô∏è  Desktop: kde, gnome, hyprland"
            ;;
        *)
            echo "‚öôÔ∏è  System: stable"
            echo "üíª Usage: workstation"
            ;;
    esac
}

# Interactive mode
interactive_setup() {
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë              Interactive NixOS Template Setup                ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Template selection
    if [[ -z "$TEMPLATE" ]]; then
        echo -e "${YELLOW}üìã Available templates:${NC}"
        echo "1) modern - üöÄ Modern dynamic system with auto-detection"
        echo "2) ephemeral-zfs - üíæ ZFS ephemeral root system"
        echo "3) minimal-zfs - üîß Minimal ZFS system"
        echo "4) deployment - üåê Deployment-focused system"
        echo "5) personal - üë§ Personal dotfiles configuration"
        echo "6) unified - üèóÔ∏è Unified disko-based system"
        echo "7) installer - üíø ZFS installer system"
        echo "8) legacy - üß™ Legacy/testing configurations"
        echo ""
        
        read -p "Select template (1-8): " template_choice
        case $template_choice in
            1) TEMPLATE="modern";;
            2) TEMPLATE="ephemeral-zfs";;
            3) TEMPLATE="minimal-zfs";;
            4) TEMPLATE="deployment";;
            5) TEMPLATE="personal";;
            6) TEMPLATE="unified";;
            7) TEMPLATE="installer";;
            8) TEMPLATE="legacy";;
            *) echo -e "${RED}Invalid selection${NC}"; exit 1;;
        esac
    fi
    
    # Hostname
    if [[ -z "$HOSTNAME" ]]; then
        read -p "üè† Enter hostname [nixos]: " input_hostname
        HOSTNAME="${input_hostname:-nixos}"
    fi
    
    # Username
    read -p "üë§ Enter username [$USERNAME]: " input_username
    USERNAME="${input_username:-$USERNAME}"
    
    # Disk selection
    echo -e "${YELLOW}üíæ Available disks:${NC}"
    lsblk -d -o NAME,SIZE,MODEL 2>/dev/null | grep -E "(nvme|sd[a-z]|hd[a-z])" || echo "Unable to detect disks automatically"
    read -p "üíΩ Enter target disk [$DISK]: " input_disk
    DISK="${input_disk:-$DISK}"
    
    # Timezone
    read -p "üåç Enter timezone [$TIMEZONE]: " input_timezone
    TIMEZONE="${input_timezone:-$TIMEZONE}"
    
    # Profiles based on template
    echo -e "${YELLOW}üîß Available profiles for ${TEMPLATE}:${NC}"
    list_profiles "$TEMPLATE"
    echo ""
    
    case "$TEMPLATE" in
        modern)
            read -p "üñ•Ô∏è  Desktop environment (kde/gnome/hyprland) [kde]: " desktop
            read -p "üì∫ Display manager (tui-greet/gdm) [auto]: " dm
            read -p "‚öôÔ∏è  System version (stable/unstable/hardened) [stable]: " sysver
            read -p "üéÆ Usage type (gaming/development) []: " usage
            PROFILES=("${desktop:-kde}" "${sysver:-stable}")
            [[ -n "$dm" && "$dm" != "auto" ]] && PROFILES+=("$dm")
            [[ -n "$usage" ]] && PROFILES+=("$usage")
            ;;
        ephemeral-zfs|minimal-zfs)
            read -p "‚öôÔ∏è  System version (stable) [stable]: " sysver
            read -p "üíª Usage (headless/desktop) [desktop]: " usage
            PROFILES=("${sysver:-stable}" "${usage:-desktop}")
            if [[ "${usage:-desktop}" == "desktop" ]]; then
                read -p "üñ•Ô∏è  Desktop environment (kde/gnome/hyprland) [kde]: " desktop
                read -p "üì∫ Display manager (tui-greet/gdm) [auto]: " dm
                PROFILES+=("${desktop:-kde}")
                [[ -n "$dm" && "$dm" != "auto" ]] && PROFILES+=("$dm")
            fi
            # ZFS-specific parameters
            read -p "üÜî ZFS Host ID (8 hex chars) [$(head -c 8 /etc/machine-id 2>/dev/null || echo 'deadbeef')]: " hostid
            PARAMS+=("hostId=${hostid:-deadbeef}")
            ;;
        personal)
            read -p "üñ•Ô∏è  Desktop environment (kde/hyprland) [kde]: " desktop
            read -p "üì∫ Display manager (tui-greet/gdm) [auto]: " dm
            read -p "‚öôÔ∏è  System version (stable/unstable) [stable]: " sysver
            read -p "üìß Email address: " email
            PROFILES=("${desktop:-kde}" "${sysver:-stable}")
            [[ -n "$dm" && "$dm" != "auto" ]] && PROFILES+=("$dm")
            [[ -n "$email" ]] && PARAMS+=("email=$email")
            ;;
        *)
            read -p "‚öôÔ∏è  System version [stable]: " sysver
            read -p "üíª Usage type [workstation]: " usage
            read -p "üñ•Ô∏è  Desktop environment (kde/gnome/hyprland) [kde]: " desktop
            PROFILES=("${sysver:-stable}" "${usage:-workstation}" "${desktop:-kde}")
            ;;
    esac
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --disk)
                DISK="$2"
                shift 2
                ;;
            --user)
                USERNAME="$2"
                shift 2
                ;;
            --timezone)
                TIMEZONE="$2"
                shift 2
                ;;
            --param)
                PARAMS+=("$2")
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --list-profiles)
                if [[ -n "$2" && ! "$2" =~ ^-- ]]; then
                    list_profiles "$2"
                    exit 0
                else
                    echo -e "${RED}Template name required for --list-profiles${NC}"
                    exit 1
                fi
                ;;
            --interactive)
                INTERACTIVE=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
            *)
                if [[ -z "$TEMPLATE" ]]; then
                    TEMPLATE="$1"
                elif [[ -z "$HOSTNAME" ]]; then
                    HOSTNAME="$1"
                else
                    PROFILES+=("$1")
                fi
                shift
                ;;
        esac
    done
}

# Validate template and configuration
validate_config() {
    # Check if template exists
    if [[ ! -d "$TEMPLATES_DIR/$TEMPLATE" ]]; then
        echo -e "${RED}‚ùå Template '$TEMPLATE' not found${NC}"
        echo -e "${YELLOW}Available templates:${NC}"
        ls -1 "$TEMPLATES_DIR" | sed 's/^/  /'
        exit 1
    fi
    
    # Check if disk exists
    if [[ ! -b "$DISK" ]] && [[ "$DRY_RUN" == "false" ]]; then
        echo -e "${RED}‚ùå Disk '$DISK' not found${NC}"
        echo -e "${YELLOW}Available disks:${NC}"
        lsblk -d -o NAME,SIZE,MODEL 2>/dev/null || echo "Unable to list disks"
        exit 1
    fi
    
    # Validate hostname
    if [[ ! "$HOSTNAME" =~ ^[a-zA-Z0-9-]+$ ]]; then
        echo -e "${RED}‚ùå Invalid hostname: $HOSTNAME${NC}"
        exit 1
    fi
    
    # Validate username
    if [[ ! "$USERNAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}‚ùå Invalid username: $USERNAME${NC}"
        exit 1
    fi
}

# Show installation summary
show_summary() {
    local config_name="$HOSTNAME.$TEMPLATE"
    if [[ ${#PROFILES[@]} -gt 0 ]]; then
        config_name="$config_name.$(IFS=.; echo "${PROFILES[*]}")"
    fi
    
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                    Installation Summary                      ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "${GREEN}üìã Template:${NC} $TEMPLATE"
    echo -e "${GREEN}üè† Hostname:${NC} $HOSTNAME"  
    echo -e "${GREEN}üë§ Username:${NC} $USERNAME"
    echo -e "${GREEN}üîß Profiles:${NC} ${PROFILES[*]:-none}"
    echo -e "${GREEN}üíΩ Target Disk:${NC} $DISK"
    echo -e "${GREEN}üåç Timezone:${NC} $TIMEZONE"
    echo -e "${GREEN}‚öôÔ∏è  Configuration:${NC} $config_name"
    
    if [[ ${#PARAMS[@]} -gt 0 ]]; then
        echo -e "${GREEN}üîß Parameters:${NC}"
        for param in "${PARAMS[@]}"; do
            echo -e "   ‚Ä¢ $param"
        done
    fi
    echo ""
}

# Execute installation
install_system() {
    local config_name="$HOSTNAME.$TEMPLATE"
    if [[ ${#PROFILES[@]} -gt 0 ]]; then
        config_name="$config_name.$(IFS=.; echo "${PROFILES[*]}")"
    fi
    
    # Build parameter arguments
    local param_args=""
    for param in "${PARAMS[@]}"; do
        param_args="$param_args --param $param"
    done
    
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would execute:${NC}"
        echo "1. üíΩ Partition disk: $DISK"
        echo "2. üì¶ Install NixOS: $config_name"
        echo "3. üë§ Setup user: $USERNAME"
        echo "4. ‚öôÔ∏è  Apply parameters: ${PARAMS[*]:-none}"
        return 0
    fi
    
    echo -e "${RED}‚ö†Ô∏è  WARNING: This will COMPLETELY ERASE $DISK!${NC}"
    read -p "Continue with installation? (yes/no): " confirm
    if [[ "$confirm" != "yes" ]]; then
        echo "‚ùå Installation aborted."
        exit 1
    fi
    
    echo -e "${BLUE}üöÄ Starting installation...${NC}"
    
    # Step 1: Partition with disko
    echo -e "${YELLOW}[1/4] üíΩ Partitioning disk with disko...${NC}"
    if ! sudo nix run github:nix-community/disko/latest -- \
        --mode disko \
        --flake "$SCRIPT_DIR#$config_name" \
        --arg device "\"$DISK\""; then
        echo -e "${RED}‚ùå Disk partitioning failed${NC}"
        exit 1
    fi
    
    # Step 2: Configure nix in target
    echo -e "${YELLOW}[2/4] ‚öôÔ∏è  Configuring nix settings...${NC}"
    sudo mkdir -p /mnt/etc/nix
    sudo tee /mnt/etc/nix/nix.conf > /dev/null << 'EOF'
experimental-features = nix-command flakes
substituters = https://cache.nixos.org https://nix-community.cachix.org
trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
max-jobs = auto
cores = 0
EOF
    
    # Step 3: Install NixOS
    echo -e "${YELLOW}[3/4] üì¶ Installing NixOS system...${NC}"
    if ! sudo nixos-install \
        --flake "$SCRIPT_DIR#$config_name" \
        --no-channel-copy \
        $param_args; then
        echo -e "${RED}‚ùå NixOS installation failed${NC}"
        exit 1
    fi
    
    # Step 4: Post-install setup
    echo -e "${YELLOW}[4/4] üîß Post-installation setup...${NC}"
    sudo nixos-enter --root /mnt -c "
        # Create user if it doesn't exist
        if ! id $USERNAME &>/dev/null; then
            useradd -m -G wheel,networkmanager,video,audio $USERNAME
        fi
        
        # Set timezone
        timedatectl set-timezone $TIMEZONE || true
        
        echo 'Please set passwords for root and $USERNAME after reboot'
    " || echo "‚ö†Ô∏è  Some post-install steps may need manual completion"
    
    # Success message
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                   ‚úÖ Installation Complete!                  ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "${CYAN}üéâ System installed with template: ${TEMPLATE}${NC}"
    echo -e "${CYAN}‚öôÔ∏è  Configuration: ${config_name}${NC}"
    echo -e "${CYAN}üë§ Username: ${USERNAME}${NC}"
    echo -e "${CYAN}üîß Next steps:${NC}"
    echo -e "   1. üîÑ Reboot: sudo reboot"
    echo -e "   2. üîë Set passwords for root and $USERNAME"
    echo -e "   3. üöÄ Enjoy your new NixOS system!"
}

# Main execution
main() {
    # Show banner
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë                   NixOS Templates Installer                  ‚ïë${NC}"
    echo -e "${PURPLE}‚ïë                 Unified Multi-Repository System             ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Parse arguments
    parse_args "$@"
    
    # Run interactive mode if requested
    if [[ "$INTERACTIVE" == "true" ]]; then
        interactive_setup
    fi
    
    # Validate required arguments
    if [[ -z "$TEMPLATE" ]] || [[ -z "$HOSTNAME" ]]; then
        echo -e "${RED}‚ùå Template and hostname are required${NC}"
        echo -e "${YELLOW}üí° Use --interactive for guided setup${NC}"
        echo -e "${YELLOW}üí° Use --help for detailed usage${NC}"
        exit 1
    fi
    
    # Validate configuration
    validate_config
    
    # Show summary
    show_summary
    
    # Execute installation
    install_system
}

# Run main function with all arguments
main "$@"